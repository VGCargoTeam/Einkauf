import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, updateDoc, arrayUnion, serverTimestamp } from 'firebase/firestore';
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";

// Tailwind CSS is assumed to be available
// For Font Awesome icons, you can include the script in the HTML head
// <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

// Global variables provided by the canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Context for Auth and Firestore
const AppContext = createContext();

const AppProvider = ({ children }) => {
  const [auth, setAuth] = useState(null);
  const [db, setDb] = useState(null);
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    let unsubscribe = () => {};
    try {
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      const dbInstance = getFirestore(app);

      setAuth(authInstance);
      setDb(dbInstance);

      unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
        if (currentUser) {
          setUser(currentUser);
          // In a real application, user roles would be stored in Firestore
          // For this demo, we use a fixed UID and a mock user to differentiate roles
          const adminUID = 'simulated-admin-uid-12345';
          setIsAdmin(currentUser.uid === adminUID);
          // Check if it's the admin demo user
          if (currentUser.email === 'admin@büro.de') {
            setIsAdmin(true);
          } else {
            setIsAdmin(false);
          }
        } else {
          setUser(null);
          setIsAdmin(false);
        }
        setLoading(false);
      });

      if (initialAuthToken) {
        signInWithCustomToken(authInstance, initialAuthToken).catch(async (e) => {
          console.error("Custom token sign-in failed:", e);
          // Fallback to anonymous sign-in if custom token fails
          await signInAnonymously(authInstance);
        });
      } else {
        signInAnonymously(authInstance);
      }
    } catch (e) {
      console.error("Firebase initialization or authentication failed:", e);
      setError("Fehler bei der Initialisierung. Bitte versuchen Sie es erneut.");
      setLoading(false);
    }

    return () => unsubscribe();
  }, []);

  return (
    <AppContext.Provider value={{ auth, db, user, isAdmin, loading, error }}>
      {children}
    </AppContext.Provider>
  );
};

const Header = () => {
  const { auth, user, isAdmin, error } = useContext(AppContext);

  const handleLogout = async () => {
    try {
      await signOut(auth);
    } catch (e) {
      console.error("Logout failed:", e);
    }
  };

  return (
    <header className="bg-white text-gray-800 p-4 shadow-lg border-b border-gray-200">
      <div className="container mx-auto flex justify-between items-center">
        <h1 className="text-2xl font-bold text-indigo-600">Büroportal</h1>
        {user && (
          <div className="flex items-center space-x-4">
            <span className="text-sm font-medium hidden sm:block">
              Eingeloggt als: <span className="font-semibold">{isAdmin ? 'Admin' : 'Benutzer'}</span>
            </span>
            <button
              onClick={handleLogout}
              className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full font-semibold transition-colors duration-300 transform hover:scale-105 shadow-md"
            >
              Abmelden
            </button>
          </div>
        )}
      </div>
      {error && (
        <div className="text-red-500 text-center mt-2">{error}</div>
      )}
    </header>
  );
};

const ProductList = () => {
  const { db, user } = useContext(AppContext);
  const [products, setProducts] = useState([]);
  const [cart, setCart] = useState({});
  const [message, setMessage] = useState('');
  const [currentPage, setCurrentPage] = useState('shop');

  // Real-time listener for products
  useEffect(() => {
    if (!db) return;
    const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
    const unsubscribe = onSnapshot(productsCollectionRef, (snapshot) => {
      const productList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setProducts(productList.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name)));
    });

    return () => unsubscribe();
  }, [db]);

  const addToCart = (productId, quantityToAdd) => {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    // Ensure quantityToAdd is a number and is greater than 0
    if (typeof quantityToAdd !== 'number' || quantityToAdd <= 0) {
      setMessage('Bitte geben Sie eine gültige Menge ein.');
      return;
    }
    
    const currentCartQuantity = cart[productId]?.quantity || 0;
    const newQuantity = currentCartQuantity + quantityToAdd;
  
    if (newQuantity > product.stock) {
      setMessage(`Nicht genügend ${product.name} auf Lager. Verfügbar: ${product.stock}`);
      return;
    }
  
    setCart(prevCart => ({
      ...prevCart,
      [productId]: {
        ...product,
        quantity: newQuantity,
      }
    }));
    setMessage(`${quantityToAdd}x ${product.name} zum Warenkorb hinzugefügt.`);
  };

  const getGroupedProducts = () => {
    const grouped = {};
    products.forEach(p => {
      if (!grouped[p.category]) {
        grouped[p.category] = [];
      }
      grouped[p.category].push(p);
    });
    return grouped;
  };

  const groupedProducts = getGroupedProducts();

  const renderContent = () => {
    switch (currentPage) {
      case 'shop':
        return (
          <>
            <div className="bg-indigo-600 text-white py-20 px-8 rounded-b-3xl shadow-lg">
              <div className="container mx-auto text-center">
                <h2 className="text-4xl md:text-5xl font-extrabold mb-4 animate-fade-in">Bürobedarf einfach bestellen</h2>
                <p className="text-lg md:text-xl mb-8 animate-fade-in-delay">Wählen Sie die benötigten Artikel aus und legen Sie sie in Ihren Warenkorb.</p>
                <button
                  onClick={() => setCurrentPage('cart')}
                  className="bg-white text-indigo-600 font-bold px-8 py-4 rounded-full shadow-xl hover:bg-gray-100 transition-colors duration-300 transform hover:scale-105 animate-bounce"
                >
                  Warenkorb ({Object.keys(cart).length}) <i className="fas fa-shopping-cart ml-2"></i>
                </button>
              </div>
            </div>
            
            <div className="container mx-auto p-8">
              {Object.keys(groupedProducts).map(category => (
                <div key={category} className="mb-12">
                  <h2 className="text-3xl font-bold mb-6 text-gray-800 border-b-2 border-indigo-400 pb-2">{category}</h2>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {groupedProducts[category].map(product => (
                      <div key={product.id} className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col items-center text-center transition-transform duration-300 transform hover:scale-105 hover:shadow-2xl">
                        <div className="relative w-full h-40 mb-4">
                          <img 
                            src={product.imageURL || `https://placehold.co/150x150/E2E8F0/1A202C?text=Kein+Bild`} 
                            alt={product.name} 
                            className="w-full h-full object-cover rounded-lg" 
                          />
                          <span className={`absolute top-2 right-2 px-2 py-1 text-xs font-bold rounded-full ${product.stock > 0 ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>
                            Lagerbestand: {product.stock}
                          </span>
                        </div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-2">{product.name}</h3>
                        <p className="text-sm text-gray-600 mb-1">Artikel-Nr.: {product.itemNumber}</p>
                        <p className="text-sm text-gray-600 mb-4 flex-1">{product.description}</p>
                        
                        <div className="flex items-center space-x-2 mt-auto">
                          <input
                            type="number"
                            defaultValue="1"
                            min="1"
                            max={product.stock}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            id={`quantity-${product.id}`}
                            onChange={(e) => {
                              const inputQuantity = parseInt(e.target.value, 10);
                              const newCart = { ...cart };
                              if (inputQuantity > 0 && inputQuantity <= product.stock) {
                                newCart[product.id] = { ...product, quantity: inputQuantity };
                                setCart(newCart);
                              } else {
                                delete newCart[product.id];
                                setCart(newCart);
                                setMessage('Bitte geben Sie eine gültige Menge ein.');
                              }
                            }}
                          />
                          <button
                            onClick={() => {
                              const quantity = parseInt(document.getElementById(`quantity-${product.id}`).value, 10);
                              addToCart(product.id, quantity);
                            }}
                            className="bg-indigo-600 text-white p-3 rounded-full shadow-md hover:bg-indigo-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            disabled={product.stock <= 0}
                          >
                            <i className="fas fa-plus"></i>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </>
        );
      case 'cart':
        return (
          <ShoppingCart cart={cart} setCart={setCart} user={user} db={db} appId={appId} setMessage={setMessage} />
        );
      default:
        return null;
    }
  };

  return (
    <>
      {message && (
        <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-green-500 text-white p-4 rounded-lg shadow-xl z-50 animate-fade-in-down">
          {message}
        </div>
      )}
      {renderContent()}
    </>
  );
};

const ShoppingCart = ({ cart, setCart, user, db, appId, setMessage }) => {
  const [isProcessing, setIsProcessing] = useState(false);

  const placeOrder = async () => {
    setIsProcessing(true);
    const orderNumber = `ORD-${Date.now()}`;
    const orderedItems = Object.values(cart);

    if (orderedItems.length === 0) {
      setMessage('Der Warenkorb ist leer.');
      setIsProcessing(false);
      return;
    }

    try {
      const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
      await setDoc(doc(ordersCollectionRef, orderNumber), {
        orderNumber: orderNumber,
        userId: user.uid,
        userName: `Benutzer ${user.uid.substring(0, 4)}`,
        items: orderedItems.map(item => ({
          name: item.name,
          itemNumber: item.itemNumber,
          quantity: item.quantity,
          imageURL: item.imageURL,
        })),
        status: 'Ausstehend',
        timestamp: serverTimestamp(),
      });

      for (const item of orderedItems) {
        const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, item.id);
        const productDoc = await getDoc(productDocRef);
        if (productDoc.exists()) {
          const newStock = productDoc.data().stock - item.quantity;
          await updateDoc(productDocRef, {
            stock: newStock,
          });
        }
      }

      setMessage('Bestellung erfolgreich aufgegeben! Sie erhalten eine Bestätigung.');
      setCart({});
    } catch (e) {
      console.error("Error placing order:", e);
      setMessage("Fehler beim Aufgeben der Bestellung. Bitte versuchen Sie es erneut.");
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <div className="container mx-auto p-8">
      <h2 className="text-3xl font-bold mb-6 text-gray-800">Ihr Warenkorb</h2>
      <div className="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
        {Object.values(cart).length === 0 ? (
          <p className="text-center text-gray-500 py-8">Ihr Warenkorb ist leer.</p>
        ) : (
          <>
            <ul className="space-y-4 mb-6">
              {Object.values(cart).map(item => (
                <li key={item.id} className="flex items-center space-x-4 bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-100">
                  <img src={item.imageURL || 'https://placehold.co/80x80/E2E8F0/1A202C?text=Bild'} alt={item.name} className="w-16 h-16 rounded-lg object-cover" />
                  <div className="flex-1">
                    <p className="font-semibold text-gray-900">{item.name}</p>
                    <p className="text-sm text-gray-600">Menge: {item.quantity}</p>
                  </div>
                  <button
                    onClick={() => {
                      const newCart = { ...cart };
                      delete newCart[item.id];
                      setCart(newCart);
                      setMessage(`${item.name} aus dem Warenkorb entfernt.`);
                    }}
                    className="text-red-500 hover:text-red-700 transition-colors p-2 rounded-full hover:bg-red-100"
                  >
                    <i className="fas fa-trash"></i>
                  </button>
                </li>
              ))}
            </ul>
            <button
              onClick={placeOrder}
              disabled={isProcessing}
              className="w-full bg-indigo-600 text-white px-6 py-3 rounded-full font-semibold shadow-md hover:bg-indigo-700 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105"
            >
              {isProcessing ? 'Bestellung wird verarbeitet...' : 'Bestellung aufgeben'}
            </button>
          </>
        )}
      </div>
    </div>
  );
};

const AdminDashboard = () => {
  const { db, user } = useContext(AppContext);
  const [orders, setOrders] = useState([]);
  const [filteredOrders, setFilteredOrders] = useState([]);
  const [products, setProducts] = useState([]);
  const [message, setMessage] = useState('');
  const [currentTab, setCurrentTab] = useState('orders');
  const [searchTerm, setSearchTerm] = useState('');
  const [dateRange, setDateRange] = useState({ start: '', end: '' });

  // Add a new state for the product to be added
  const [newProduct, setNewProduct] = useState({
    name: '',
    itemNumber: '',
    category: '',
    description: '',
    stock: 0,
    imageURL: '',
  });

  // Real-time listener for orders
  useEffect(() => {
    if (!db) return;
    const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
    const unsubscribe = onSnapshot(ordersCollectionRef, (snapshot) => {
      const orderList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setOrders(orderList);
      setFilteredOrders(orderList); // Initialize with all orders
    });
    return () => unsubscribe();
  }, [db]);

  // Real-time listener for products
  useEffect(() => {
    if (!db) return;
    const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
    const unsubscribe = onSnapshot(productsCollectionRef, (snapshot) => {
      const productList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setProducts(productList.sort((a, b) => a.name.localeCompare(b.name)));
    });
    return () => unsubscribe();
  }, [db]);

  // Filtering logic
  useEffect(() => {
    let tempOrders = [...orders];

    if (searchTerm) {
      tempOrders = tempOrders.filter(order =>
        order.orderNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
        order.userName.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    if (dateRange.start && dateRange.end) {
      const startDate = new Date(dateRange.start);
      const endDate = new Date(dateRange.end);
      tempOrders = tempOrders.filter(order => {
        const orderDate = order.timestamp?.toDate();
        return orderDate >= startDate && orderDate <= endDate;
      });
    }

    setFilteredOrders(tempOrders);
  }, [orders, searchTerm, dateRange]);

  const addNewProduct = async (e) => {
    e.preventDefault();
    if (!newProduct.name || !newProduct.itemNumber || !newProduct.category) {
      setMessage('Bitte füllen Sie alle erforderlichen Felder aus.');
      return;
    }

    try {
      const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
      await setDoc(doc(productsCollectionRef), { ...newProduct, stock: parseInt(newProduct.stock, 10) });
      setMessage('Neuer Artikel erfolgreich hinzugefügt!');
      setNewProduct({
        name: '',
        itemNumber: '',
        category: '',
        description: '',
        stock: 0,
        imageURL: '',
      });
    } catch (e) {
      console.error("Error adding new product:", e);
      setMessage("Fehler beim Hinzufügen des Artikels.");
    }
  };

  const updateProductStock = async (productId, newStock) => {
    try {
      const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
      await updateDoc(productDocRef, {
        stock: parseInt(newStock, 10),
      });
      setMessage('Lagerbestand erfolgreich aktualisiert!');
    } catch (e) {
      console.error("Error updating stock:", e);
      setMessage("Fehler beim Aktualisieren des Lagerbestands.");
    }
  };

  const fulfillOrder = async (orderId) => {
    try {
      const orderDocRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
      await updateDoc(orderDocRef, {
        status: 'Ausgegeben',
        fulfillmentTimestamp: serverTimestamp(),
        // Store who fulfilled the order
        fulfilledBy: `Admin ${user.uid.substring(0, 4)}`
      });
      setMessage(`Bestellung ${orderId} als 'Ausgegeben' markiert.`);
    } catch (e) {
      console.error("Error fulfilling order:", e);
      setMessage("Fehler beim Aktualisieren der Bestellung.");
    }
  };

  const handleDateChange = (e) => {
    const { name, value } = e.target;
    setDateRange(prev => ({ ...prev, [name]: value }));
  };

  return (
    <div className="container mx-auto p-8 space-y-8">
      <h1 className="text-4xl font-bold text-gray-800 mb-6">Admin Dashboard</h1>

      {message && <div className="bg-indigo-100 text-indigo-700 p-4 rounded-lg mb-4 text-center">{message}</div>}

      {/* Tabs for Navigation */}
      <div className="flex justify-center border-b border-gray-300">
        <button
          onClick={() => setCurrentTab('orders')}
          className={`px-6 py-3 font-semibold transition-colors ${currentTab === 'orders' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
        >
          Bestellungen
        </button>
        <button
          onClick={() => setCurrentTab('products')}
          className={`px-6 py-3 font-semibold transition-colors ${currentTab === 'products' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`}
        >
          Artikel verwalten
        </button>
      </div>

      {currentTab === 'orders' && (
        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
          <h2 className="text-2xl font-bold mb-4">Bestellungen</h2>
          {/* Search and Filter */}
          <div className="mb-6 space-y-4 md:space-y-0 md:flex md:space-x-4">
            <input
              type="text"
              placeholder="Nach Bestell-Nr. oder Benutzer suchen"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <div className="flex space-x-2">
              <input
                type="date"
                name="start"
                value={dateRange.start}
                onChange={handleDateChange}
                className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <input
                type="date"
                name="end"
                value={dateRange.end}
                onChange={handleDateChange}
                className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
          </div>
          <div className="space-y-4">
            {filteredOrders.length === 0 ? (
              <p className="text-center text-gray-500">Keine Bestellungen gefunden.</p>
            ) : (
              filteredOrders.map(order => (
                <div key={order.id} className={`p-4 rounded-lg shadow-sm border ${order.status === 'Ausstehend' ? 'border-yellow-400 bg-yellow-50' : 'border-green-400 bg-green-50'}`}>
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-lg text-gray-900">Bestell-Nr.: {order.orderNumber}</h3>
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${order.status === 'Ausstehend' ? 'bg-yellow-500 text-white' : 'bg-green-500 text-white'}`}>
                      {order.status}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 mb-1">Bestellt von: <span className="font-medium text-gray-800">{order.userName}</span></p>
                  <p className="text-sm text-gray-600">Datum: <span className="font-medium text-gray-800">{new Date(order.timestamp?.toDate()).toLocaleString()}</span></p>
                  <ul className="list-disc list-inside mt-4 text-sm space-y-1">
                    {order.items.map((item, index) => (
                      <li key={index} className="text-gray-700">
                        <span className="font-medium">{item.name}</span> ({item.quantity} Stk.)
                      </li>
                    ))}
                  </ul>
                  {order.status === 'Ausstehend' && (
                    <button
                      onClick={() => fulfillOrder(order.id)}
                      className="mt-4 bg-green-600 text-white px-4 py-2 rounded-full font-semibold shadow-md hover:bg-green-700 transition-colors transform hover:scale-105"
                    >
                      Als 'Ausgegeben' markieren
                    </button>
                  )}
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {currentTab === 'products' && (
        <div className="space-y-8">
          {/* Abschnitt: Neuer Artikel hinzufügen */}
          <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 className="text-2xl font-bold mb-4">Neuen Artikel hinzufügen</h2>
            <form onSubmit={addNewProduct} className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input
                type="text"
                placeholder="Name des Artikels"
                value={newProduct.name}
                onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg"
                required
              />
              <input
                type="text"
                placeholder="Artikelnummer"
                value={newProduct.itemNumber}
                onChange={(e) => setNewProduct({ ...newProduct, itemNumber: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg"
                required
              />
              <input
                type="text"
                placeholder="Kategorie"
                value={newProduct.category}
                onChange={(e) => setNewProduct({ ...newProduct, category: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg"
                required
              />
              <input
                type="text"
                placeholder="Beschreibung"
                value={newProduct.description}
                onChange={(e) => setNewProduct({ ...newProduct, description: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg"
              />
              <input
                type="number"
                placeholder="Lagerbestand"
                value={newProduct.stock}
                onChange={(e) => setNewProduct({ ...newProduct, stock: parseInt(e.target.value, 10) })}
                className="w-full p-3 border border-gray-300 rounded-lg"
                min="0"
              />
              <input
                type="text"
                placeholder="Bild-URL (z.B. https://...)"
                value={newProduct.imageURL}
                onChange={(e) => setNewProduct({ ...newProduct, imageURL: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg"
              />
              <button type="submit" className="col-span-1 md:col-span-2 bg-indigo-600 text-white p-3 rounded-full font-semibold shadow-md hover:bg-indigo-700 transition-colors transform hover:scale-105">
                Artikel hinzufügen
              </button>
            </form>
          </div>

          {/* Abschnitt: Lagerbestand aktualisieren */}
          <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 className="text-2xl font-bold mb-4">Lagerbestand aktualisieren</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {products.map(product => (
                <div key={product.id} className="flex items-center space-x-4 p-4 rounded-lg bg-gray-50 shadow-sm border border-gray-100">
                  <span className="flex-1 font-semibold">{product.name}</span>
                  <input
                    type="number"
                    defaultValue={product.stock}
                    min="0"
                    className="w-20 p-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    onChange={(e) => updateProductStock(product.id, parseInt(e.target.value, 10))}
                  />
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const Login = () => {
  const { auth } = useContext(AppContext);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoginMode, setIsLoginMode] = useState(true);
  const [message, setMessage] = useState('');

  const handleAuth = async (e) => {
    e.preventDefault();
    setMessage('');
    try {
      if (isLoginMode) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
    } catch (e) {
      console.error("Auth error:", e);
      setMessage(`Anmeldefehler: ${e.message}`);
    }
  };

  const handleDemoLogin = async (demoEmail, demoPassword) => {
    setMessage('');
    try {
      await signInWithEmailAndPassword(auth, demoEmail, demoPassword);
    } catch (e) {
      if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
        try {
          await createUserWithEmailAndPassword(auth, demoEmail, demoPassword);
          await signInWithEmailAndPassword(auth, demoEmail, demoPassword);
        } catch (createError) {
          console.error("Demo user creation failed:", createError);
          setMessage("Fehler bei der Erstellung des Demo-Benutzers.");
        }
      } else {
        console.error("Demo login error:", e);
        setMessage("Fehler beim Demo-Login.");
      }
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans">
      <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all duration-300 hover:scale-105">
        <h2 className="text-3xl font-bold mb-6 text-gray-800">{isLoginMode ? 'Anmelden' : 'Registrieren'}</h2>
        {message && <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4">{message}</div>}
        <form onSubmit={handleAuth} className="space-y-4">
          <input
            type="email"
            placeholder="E-Mail-Adresse"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"
            required
          />
          <input
            type="password"
            placeholder="Passwort"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"
            required
          />
          <button
            type="submit"
            className="w-full bg-indigo-600 text-white p-3 rounded-full font-semibold shadow-md hover:bg-indigo-700 transition-colors duration-300"
          >
            {isLoginMode ? 'Anmelden' : 'Registrieren'}
          </button>
        </form>
        <div className="mt-4 text-sm">
          <button
            onClick={() => setIsLoginMode(!isLoginMode)}
            className="text-indigo-600 hover:text-indigo-800 transition-colors font-medium"
          >
            {isLoginMode ? 'Kein Konto? Jetzt registrieren' : 'Sie haben bereits ein Konto? Anmelden'}
          </button>
        </div>
        <div className="mt-6 border-t pt-6 border-gray-200">
          <h3 className="text-lg font-semibold mb-3 text-gray-700">Demo-Anmeldungen</h3>
          <div className="space-y-2">
            <button
              onClick={() => handleDemoLogin('admin@büro.de', 'admin123')}
              className="w-full bg-gray-200 text-gray-800 p-3 rounded-full font-semibold hover:bg-gray-300 transition-colors"
            >
              Demo-Admin anmelden
            </button>
            <button
              onClick={() => handleDemoLogin('user@büro.de', 'user123')}
              className="w-full bg-gray-200 text-gray-800 p-3 rounded-full font-semibold hover:bg-gray-300 transition-colors"
            >
              Demo-Benutzer anmelden
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Main App Component
const App = () => {
  const { user, isAdmin, loading, error } = useContext(AppContext);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans">
        <div className="loader"></div>
      </div>
    );
  }

  if (error) {
    return <div className="text-center p-8 text-red-500">{error}</div>;
  }

  if (!user) {
    return <Login />;
  }

  return (
    <div className="min-h-screen bg-gray-100 font-sans">
      <style jsx="true">{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 8px solid #E2E8F0;
            border-top: 8px solid #4F46E5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 1s ease-in-out;
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-in-out;
        }
        .animate-fade-in-delay {
            animation: fadeIn 1s ease-in-out 0.5s forwards;
            opacity: 0;
        }
        .animate-bounce {
          animation: bounce 1s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
      `}</style>
      <Header />
      <main>
        {isAdmin ? <AdminDashboard /> : <ProductList />}
      </main>
    </div>
  );
};

export default () => (
  <AppProvider>
    <App />
  </AppProvider>
);
